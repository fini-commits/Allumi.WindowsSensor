# ğŸ“Š Database Integration Guide

## Overview
This document describes how the Windows Sensor app integrates with Allumi's Supabase database, including activity tracking, sync flow, and AI categorization.

---

## ğŸ—„ï¸ Database Tables

### 1ï¸âƒ£ `devices` Table
Stores registered device information.

```typescript
{
  id: string,                    // Unique device ID (UUID generated by installer)
  user_id: string,               // UUID of the user
  device_name: string,           // "My Laptop", "Work PC", etc.
  device_type: string,           // "desktop" (default)
  os_version: string | null,     // "Windows 11", "Windows 10", etc.
  is_active: boolean,            // true/false
  last_seen: timestamp,          // Auto-updated on every sync
  sync_frequency_seconds: number, // Default: 60 (not used anymore, instant sync)
  created_at: timestamp,
  updated_at: timestamp
}
```

**Created by**: `generate-custom-installer` edge function  
**Updated by**: `sync-device-activity` edge function (updates `last_seen` on every sync)

---

### 2ï¸âƒ£ `device_api_keys` Table
Stores API keys for device authentication.

```typescript
{
  id: uuid,
  user_id: uuid,
  device_id: string,              // Links to devices.id
  api_key_encrypted: string,      // Currently PLAIN for testing (encryption_version: 0)
  encryption_version: number,     // 0 = unencrypted, 1+ = encrypted
  is_active: boolean,
  expires_at: timestamp | null,
  last_accessed_at: timestamp | null,
  created_at: timestamp
}
```

**Created by**: `generate-custom-installer` edge function  
**Used by**: Windows Sensor app (sends in Authorization header or request body)

---

### 3ï¸âƒ£ `device_activities` Table â­ **MAIN TABLE**
This is where all app usage data gets stored.

```typescript
{
  id: uuid,                       // Auto-generated by database
  user_id: uuid,                  // Required - from device config
  device_id: string,              // Required - from device config
  device_name: string,            // Required - "My Laptop"
  device_type: string,            // Default: "desktop"
  
  // Activity Details (sent by Windows app)
  app_name: string,               // Required - "Chrome", "Visual Studio Code"
  window_title: string | null,    // Optional - Active window title
  category: string,               // Default: "other", AI updates later
  
  // Timing (sent by Windows app)
  start_time: timestamp,          // Required - when activity started
  end_time: timestamp | null,     // Optional - when activity ended
  duration_seconds: number,       // Default: 0
  
  // AI Analysis (populated LATER by categorize-activities)
  ai_subcategory: string | null,  // AI-generated subcategory
  ai_confidence: number | null,   // 0-100
  ai_reasoning: string | null,    // Why AI chose this category
  productivity_score: number | null, // 0-100
  
  // Metadata
  is_idle: boolean,               // Default: false
  created_at: timestamp,
  updated_at: timestamp
}
```

**Created by**: `sync-device-activity` edge function (inserts rows)  
**Updated by**: `categorize-activities` edge function (adds AI analysis)

---

## ğŸ”„ The Sync Flow

```
Windows Sensor App
       â”‚
       â”‚ Tracks active window every 250ms
       â”‚ Detects app switches
       â”‚
       â–¼
   CloseCurrentSession()
       â”‚
       â”‚ Creates ActivityEvent:
       â”‚ {
       â”‚   appName: "Google Chrome",
       â”‚   windowTitle: "GitHub - Repository",
       â”‚   startTime: "2025-10-15T18:45:00Z",
       â”‚   endTime: "2025-10-15T18:46:30Z",
       â”‚   durationSeconds: 90,
       â”‚   category: "other",
       â”‚   isIdle: false
       â”‚ }
       â”‚
       â–¼
   Task.Run(() => {
     QueueActivity(ev);
     FlushActivitiesAsync();
   })
       â”‚
       â–¼
SyncClient.FlushActivitiesAsync()
       â”‚
       â”‚ POST to /sync-device-activity
       â”‚ Headers:
       â”‚   - Content-Type: application/json
       â”‚ Body:
       â”‚ {
       â”‚   "apiKey": "alm_xxx",
       â”‚   "activities": [...],
       â”‚   "deviceInfo": {
       â”‚     "deviceName": "My Laptop",
       â”‚     "deviceType": "desktop",
       â”‚     "osVersion": "Windows 11"
       â”‚   }
       â”‚ }
       â”‚
       â–¼
Edge Function: sync-device-activity
       â”‚
       â”œâ”€ Validate API key
       â”‚
       â”œâ”€ Get user_id and device_id from API key
       â”‚
       â”œâ”€ For each activity:
       â”‚  â””â”€ INSERT INTO device_activities
       â”‚     - Sets user_id, device_id, device_name, device_type from auth
       â”‚     - Uses app_name, window_title, etc. from request
       â”‚     - Sets category = "other" (default)
       â”‚     - AI fields remain null
       â”‚
       â”œâ”€ UPDATE devices.last_seen = NOW()
       â”‚
       â””â”€ Trigger categorize-activities (async)
              â”‚
              â–¼
         AI Categorization
              â”‚
              â”œâ”€ Analyze app_name + window_title
              â”‚
              â””â”€ UPDATE device_activities SET
                 - ai_subcategory = "Development"
                 - ai_confidence = 95
                 - ai_reasoning = "Visual Studio Code with .cs file"
                 - productivity_score = 85
                 - category = "productive"
```

---

## ğŸ“¤ Request Format

### POST `/sync-device-activity`

**Headers:**
```
Content-Type: application/json
```

**Body:**
```json
{
  "apiKey": "alm_87drird26qywqlf7kp1b1f",
  "activities": [
    {
      "appName": "Google Chrome",
      "windowTitle": "GitHub - Repository",
      "startTime": "2025-10-15T18:45:00Z",
      "endTime": "2025-10-15T18:46:30Z",
      "durationSeconds": 90,
      "category": "other",
      "isIdle": false
    },
    {
      "appName": "Visual Studio Code",
      "windowTitle": "Main.cs - MyProject",
      "startTime": "2025-10-15T18:46:30Z",
      "endTime": "2025-10-15T18:50:00Z",
      "durationSeconds": 210,
      "category": "other",
      "isIdle": false
    }
  ],
  "deviceInfo": {
    "deviceName": "My Laptop",
    "deviceType": "desktop",
    "osVersion": "Windows 11"
  }
}
```

**Response (Success):**
```json
{
  "success": true,
  "activitiesInserted": 2
}
```

**Response (Error):**
```json
{
  "error": "Invalid API key"
}
```

---

## ğŸ¤– AI Categorization

### How It Works

1. **Windows app sends activity** with `category: "other"` (default)
2. **Edge function inserts** row into `device_activities` with all AI fields = null
3. **Categorize-activities triggers** (async, doesn't block sync response)
4. **AI analyzes** the `app_name` + `window_title` combination
5. **Updates the row** with AI analysis:
   - `ai_subcategory`: e.g., "Development", "Communication", "Entertainment"
   - `ai_confidence`: 0-100 (how sure the AI is)
   - `ai_reasoning`: Why this category was chosen
   - `productivity_score`: 0-100 (productivity rating)
   - `category`: Updates from "other" to actual category

### Example AI Categorization

**Input:**
```json
{
  "appName": "Visual Studio Code",
  "windowTitle": "Program.cs - Allumi.WindowsSensor"
}
```

**AI Output:**
```json
{
  "category": "Development",
  "ai_subcategory": "Coding",
  "ai_confidence": 98,
  "ai_reasoning": "Visual Studio Code is a code editor, actively editing a C# file in a Windows Sensor project",
  "productivity_score": 90
}
```

---

## ğŸ”‘ Authentication Flow

### 1. Installation (First Time)
```
User visits Allumi dashboard
       â”‚
       â–¼
Clicks "Download Sensor"
       â”‚
       â–¼
generate-custom-installer edge function:
       â”‚
       â”œâ”€ Creates device record in devices table
       â”‚
       â”œâ”€ Generates API key
       â”‚
       â”œâ”€ Stores in device_api_keys table
       â”‚
       â”œâ”€ Downloads base Setup.exe from GitHub
       â”‚
       â”œâ”€ Embeds config JSON:
       â”‚  {
       â”‚    "deviceId": "uuid",
       â”‚    "deviceName": "My Laptop",
       â”‚    "apiKey": "alm_xxx",
       â”‚    "syncUrl": "https://...supabase.co/functions/v1/sync-device-activity",
       â”‚    "supabaseUrl": "https://...supabase.co",
       â”‚    "userId": "uuid"
       â”‚  }
       â”‚
       â””â”€ Returns custom Setup.exe to user
```

### 2. App Startup
```
User runs Setup.exe
       â”‚
       â–¼
Installs to: C:\Users\{user}\AppData\Local\AllumiWindowsSensor\
       â”‚
       â–¼
First run:
       â”‚
       â”œâ”€ EmbeddedConfigReader.ExtractEmbeddedConfig()
       â”‚  â””â”€ Checks Setup.exe for <<<ALLUMI_CONFIG>>> markers
       â”‚
       â”œâ”€ Extracts config JSON
       â”‚
       â”œâ”€ Saves to: %APPDATA%\Allumi\config.json
       â”‚
       â””â”€ Stores API key in Windows Credential Manager
```

### 3. OAuth Fallback (if no embedded config)
```
No embedded config found
       â”‚
       â–¼
Show balloon tip: "Click to authenticate"
       â”‚
       â–¼
User clicks â†’ OAuthHandler.AuthenticateAsync()
       â”‚
       â”œâ”€ Opens browser: {supabaseUrl}/auth
       â”‚
       â”œâ”€ User logs in
       â”‚
       â”œâ”€ Redirects to: allumi://callback?token=xxx
       â”‚
       â”œâ”€ Windows protocol handler catches URL
       â”‚
       â””â”€ Saves config and restarts app
```

---

## ğŸ“Š Data Flow Summary

### Windows App â†’ Database
```
ActivityEvent (app)
  â””â”€ appName
  â””â”€ windowTitle
  â””â”€ startTime
  â””â”€ endTime
  â””â”€ durationSeconds
  â””â”€ category = "other"
  â””â”€ isIdle

      â†“ sent via SyncClient

SyncActivityRequest (API)
  â””â”€ apiKey
  â””â”€ activities[]
  â””â”€ deviceInfo
      â””â”€ deviceName
      â””â”€ deviceType
      â””â”€ osVersion

      â†“ POST to edge function

device_activities (database row)
  â””â”€ id (auto-generated)
  â””â”€ user_id (from API key)
  â””â”€ device_id (from API key)
  â””â”€ device_name (from deviceInfo)
  â””â”€ device_type (from deviceInfo)
  â””â”€ app_name (from activity.appName)
  â””â”€ window_title (from activity.windowTitle)
  â””â”€ start_time (from activity.startTime)
  â””â”€ end_time (from activity.endTime)
  â””â”€ duration_seconds (from activity.durationSeconds)
  â””â”€ category (from activity.category = "other")
  â””â”€ is_idle (from activity.isIdle)
  â””â”€ ai_subcategory (null initially)
  â””â”€ ai_confidence (null initially)
  â””â”€ ai_reasoning (null initially)
  â””â”€ productivity_score (null initially)

      â†“ AI categorization (async)

device_activities (updated)
  â””â”€ ai_subcategory = "Development"
  â””â”€ ai_confidence = 95
  â””â”€ ai_reasoning = "..."
  â””â”€ productivity_score = 85
  â””â”€ category = "productive"
```

---

## âœ… What's Implemented

- âœ… Activity tracking (250ms polling)
- âœ… Instant sync (no batching delay)
- âœ… ISO 8601 timestamps
- âœ… Device info in every sync
- âœ… Idle detection
- âœ… API key authentication
- âœ… Embedded config in installer
- âœ… OAuth fallback
- âœ… Windows Credential Manager
- âœ… Retry logic on network errors
- âœ… Proper database schema alignment

---

## ğŸ¯ Key Points for Backend

1. **Windows app sends `category: "other"`** for all activities
2. **Edge function should NOT expect AI fields** in the request (they're null)
3. **AI categorization happens AFTER insert** (async, doesn't block sync)
4. **Device info comes from deviceInfo object**, not from individual activities
5. **API key is in request body**, not Authorization header
6. **Timestamps are ISO 8601** with timezone: `2025-10-15T18:45:00Z`
7. **Activities sent instantly** on every app switch (no 60s delay)

---

## ğŸ“ Example Logs

### Windows App Log (sensor.log)
```
2025-10-15T18:45:00Z    proc=chrome        title=GitHub    status=active    dur=90s
2025-10-15T18:46:30Z    proc=Code          title=Main.cs   status=active    dur=210s
```

### Edge Function Log
```
[sync-device-activity] Received 2 activities for device: abc-123
[sync-device-activity] Inserted 2 activities for user: xyz-789
[sync-device-activity] Updated device last_seen
[sync-device-activity] Triggered AI categorization
```

### Database State (Before AI)
```sql
SELECT app_name, category, ai_subcategory, ai_confidence 
FROM device_activities 
WHERE device_id = 'abc-123';
```
```
app_name              | category | ai_subcategory | ai_confidence
----------------------|----------|----------------|---------------
Google Chrome         | other    | NULL           | NULL
Visual Studio Code    | other    | NULL           | NULL
```

### Database State (After AI)
```sql
SELECT app_name, category, ai_subcategory, ai_confidence, productivity_score
FROM device_activities 
WHERE device_id = 'abc-123';
```
```
app_name              | category    | ai_subcategory | ai_confidence | productivity_score
----------------------|-------------|----------------|---------------|-------------------
Google Chrome         | research    | Web Browsing   | 85            | 60
Visual Studio Code    | productive  | Development    | 98            | 90
```

---

## ğŸš€ Testing the Integration

1. **Install app** with embedded config
2. **Use the app** (switch between Chrome, Code, etc.)
3. **Check Supabase** logs for incoming POST requests
4. **Query device_activities** to see inserted rows
5. **Wait for AI** categorization to complete
6. **View /sessions** page in dashboard to see categorized data

Expected behavior:
- âœ… Activities appear in database immediately (within seconds)
- âœ… `last_seen` timestamp updates on every sync
- âœ… AI fields populate within a few seconds after insert
- âœ… Dashboard shows real-time activity data
