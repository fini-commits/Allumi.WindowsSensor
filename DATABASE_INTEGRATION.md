# 📊 Database Integration Guide

## Overview
This document describes how the Windows Sensor app integrates with Allumi's Supabase database, including activity tracking, sync flow, and AI categorization.

---

## 🗄️ Database Tables

### 1️⃣ `devices` Table
Stores registered device information.

```typescript
{
  id: string,                    // Unique device ID (UUID generated by installer)
  user_id: string,               // UUID of the user
  device_name: string,           // "My Laptop", "Work PC", etc.
  device_type: string,           // "desktop" (default)
  os_version: string | null,     // "Windows 11", "Windows 10", etc.
  is_active: boolean,            // true/false
  last_seen: timestamp,          // Auto-updated on every sync
  sync_frequency_seconds: number, // Default: 60 (not used anymore, instant sync)
  created_at: timestamp,
  updated_at: timestamp
}
```

**Created by**: `generate-custom-installer` edge function  
**Updated by**: `sync-device-activity` edge function (updates `last_seen` on every sync)

---

### 2️⃣ `device_api_keys` Table
Stores API keys for device authentication.

```typescript
{
  id: uuid,
  user_id: uuid,
  device_id: string,              // Links to devices.id
  api_key_encrypted: string,      // Currently PLAIN for testing (encryption_version: 0)
  encryption_version: number,     // 0 = unencrypted, 1+ = encrypted
  is_active: boolean,
  expires_at: timestamp | null,
  last_accessed_at: timestamp | null,
  created_at: timestamp
}
```

**Created by**: `generate-custom-installer` edge function  
**Used by**: Windows Sensor app (sends in Authorization header or request body)

---

### 3️⃣ `device_activities` Table ⭐ **MAIN TABLE**
This is where all app usage data gets stored.

```typescript
{
  id: uuid,                       // Auto-generated by database
  user_id: uuid,                  // Required - from device config
  device_id: string,              // Required - from device config
  device_name: string,            // Required - "My Laptop"
  device_type: string,            // Default: "desktop"
  
  // Activity Details (sent by Windows app)
  app_name: string,               // Required - "Chrome", "Visual Studio Code"
  window_title: string | null,    // Optional - Active window title
  category: string,               // Default: "other", AI updates later
  
  // Timing (sent by Windows app)
  start_time: timestamp,          // Required - when activity started
  end_time: timestamp | null,     // Optional - when activity ended
  duration_seconds: number,       // Default: 0
  
  // AI Analysis (populated LATER by categorize-activities)
  ai_subcategory: string | null,  // AI-generated subcategory
  ai_confidence: number | null,   // 0-100
  ai_reasoning: string | null,    // Why AI chose this category
  productivity_score: number | null, // 0-100
  
  // Metadata
  is_idle: boolean,               // Default: false
  created_at: timestamp,
  updated_at: timestamp
}
```

**Created by**: `sync-device-activity` edge function (inserts rows)  
**Updated by**: `categorize-activities` edge function (adds AI analysis)

---

## 🔄 The Sync Flow

```
Windows Sensor App
       │
       │ Tracks active window every 250ms
       │ Detects app switches
       │
       ▼
   CloseCurrentSession()
       │
       │ Creates ActivityEvent:
       │ {
       │   appName: "Google Chrome",
       │   windowTitle: "GitHub - Repository",
       │   startTime: "2025-10-15T18:45:00Z",
       │   endTime: "2025-10-15T18:46:30Z",
       │   durationSeconds: 90,
       │   category: "other",
       │   isIdle: false
       │ }
       │
       ▼
   Task.Run(() => {
     QueueActivity(ev);
     FlushActivitiesAsync();
   })
       │
       ▼
SyncClient.FlushActivitiesAsync()
       │
       │ POST to /sync-device-activity
       │ Headers:
       │   - Content-Type: application/json
       │ Body:
       │ {
       │   "apiKey": "alm_xxx",
       │   "activities": [...],
       │   "deviceInfo": {
       │     "deviceName": "My Laptop",
       │     "deviceType": "desktop",
       │     "osVersion": "Windows 11"
       │   }
       │ }
       │
       ▼
Edge Function: sync-device-activity
       │
       ├─ Validate API key
       │
       ├─ Get user_id and device_id from API key
       │
       ├─ For each activity:
       │  └─ INSERT INTO device_activities
       │     - Sets user_id, device_id, device_name, device_type from auth
       │     - Uses app_name, window_title, etc. from request
       │     - Sets category = "other" (default)
       │     - AI fields remain null
       │
       ├─ UPDATE devices.last_seen = NOW()
       │
       └─ Trigger categorize-activities (async)
              │
              ▼
         AI Categorization
              │
              ├─ Analyze app_name + window_title
              │
              └─ UPDATE device_activities SET
                 - ai_subcategory = "Development"
                 - ai_confidence = 95
                 - ai_reasoning = "Visual Studio Code with .cs file"
                 - productivity_score = 85
                 - category = "productive"
```

---

## 📤 Request Format

### POST `/sync-device-activity`

**Headers:**
```
Content-Type: application/json
```

**Body:**
```json
{
  "apiKey": "alm_87drird26qywqlf7kp1b1f",
  "activities": [
    {
      "appName": "Google Chrome",
      "windowTitle": "GitHub - Repository",
      "startTime": "2025-10-15T18:45:00Z",
      "endTime": "2025-10-15T18:46:30Z",
      "durationSeconds": 90,
      "category": "other",
      "isIdle": false
    },
    {
      "appName": "Visual Studio Code",
      "windowTitle": "Main.cs - MyProject",
      "startTime": "2025-10-15T18:46:30Z",
      "endTime": "2025-10-15T18:50:00Z",
      "durationSeconds": 210,
      "category": "other",
      "isIdle": false
    }
  ],
  "deviceInfo": {
    "deviceName": "My Laptop",
    "deviceType": "desktop",
    "osVersion": "Windows 11"
  }
}
```

**Response (Success):**
```json
{
  "success": true,
  "activitiesInserted": 2
}
```

**Response (Error):**
```json
{
  "error": "Invalid API key"
}
```

---

## 🤖 AI Categorization

### How It Works

1. **Windows app sends activity** with `category: "other"` (default)
2. **Edge function inserts** row into `device_activities` with all AI fields = null
3. **Categorize-activities triggers** (async, doesn't block sync response)
4. **AI analyzes** the `app_name` + `window_title` combination
5. **Updates the row** with AI analysis:
   - `ai_subcategory`: e.g., "Development", "Communication", "Entertainment"
   - `ai_confidence`: 0-100 (how sure the AI is)
   - `ai_reasoning`: Why this category was chosen
   - `productivity_score`: 0-100 (productivity rating)
   - `category`: Updates from "other" to actual category

### Example AI Categorization

**Input:**
```json
{
  "appName": "Visual Studio Code",
  "windowTitle": "Program.cs - Allumi.WindowsSensor"
}
```

**AI Output:**
```json
{
  "category": "Development",
  "ai_subcategory": "Coding",
  "ai_confidence": 98,
  "ai_reasoning": "Visual Studio Code is a code editor, actively editing a C# file in a Windows Sensor project",
  "productivity_score": 90
}
```

---

## 🔑 Authentication Flow

### 1. Installation (First Time)
```
User visits Allumi dashboard
       │
       ▼
Clicks "Download Sensor"
       │
       ▼
generate-custom-installer edge function:
       │
       ├─ Creates device record in devices table
       │
       ├─ Generates API key
       │
       ├─ Stores in device_api_keys table
       │
       ├─ Downloads base Setup.exe from GitHub
       │
       ├─ Embeds config JSON:
       │  {
       │    "deviceId": "uuid",
       │    "deviceName": "My Laptop",
       │    "apiKey": "alm_xxx",
       │    "syncUrl": "https://...supabase.co/functions/v1/sync-device-activity",
       │    "supabaseUrl": "https://...supabase.co",
       │    "userId": "uuid"
       │  }
       │
       └─ Returns custom Setup.exe to user
```

### 2. App Startup
```
User runs Setup.exe
       │
       ▼
Installs to: C:\Users\{user}\AppData\Local\AllumiWindowsSensor\
       │
       ▼
First run:
       │
       ├─ EmbeddedConfigReader.ExtractEmbeddedConfig()
       │  └─ Checks Setup.exe for <<<ALLUMI_CONFIG>>> markers
       │
       ├─ Extracts config JSON
       │
       ├─ Saves to: %APPDATA%\Allumi\config.json
       │
       └─ Stores API key in Windows Credential Manager
```

### 3. OAuth Fallback (if no embedded config)
```
No embedded config found
       │
       ▼
Show balloon tip: "Click to authenticate"
       │
       ▼
User clicks → OAuthHandler.AuthenticateAsync()
       │
       ├─ Opens browser: {supabaseUrl}/auth
       │
       ├─ User logs in
       │
       ├─ Redirects to: allumi://callback?token=xxx
       │
       ├─ Windows protocol handler catches URL
       │
       └─ Saves config and restarts app
```

---

## 📊 Data Flow Summary

### Windows App → Database
```
ActivityEvent (app)
  └─ appName
  └─ windowTitle
  └─ startTime
  └─ endTime
  └─ durationSeconds
  └─ category = "other"
  └─ isIdle

      ↓ sent via SyncClient

SyncActivityRequest (API)
  └─ apiKey
  └─ activities[]
  └─ deviceInfo
      └─ deviceName
      └─ deviceType
      └─ osVersion

      ↓ POST to edge function

device_activities (database row)
  └─ id (auto-generated)
  └─ user_id (from API key)
  └─ device_id (from API key)
  └─ device_name (from deviceInfo)
  └─ device_type (from deviceInfo)
  └─ app_name (from activity.appName)
  └─ window_title (from activity.windowTitle)
  └─ start_time (from activity.startTime)
  └─ end_time (from activity.endTime)
  └─ duration_seconds (from activity.durationSeconds)
  └─ category (from activity.category = "other")
  └─ is_idle (from activity.isIdle)
  └─ ai_subcategory (null initially)
  └─ ai_confidence (null initially)
  └─ ai_reasoning (null initially)
  └─ productivity_score (null initially)

      ↓ AI categorization (async)

device_activities (updated)
  └─ ai_subcategory = "Development"
  └─ ai_confidence = 95
  └─ ai_reasoning = "..."
  └─ productivity_score = 85
  └─ category = "productive"
```

---

## ✅ What's Implemented

- ✅ Activity tracking (250ms polling)
- ✅ Instant sync (no batching delay)
- ✅ ISO 8601 timestamps
- ✅ Device info in every sync
- ✅ Idle detection
- ✅ API key authentication
- ✅ Embedded config in installer
- ✅ OAuth fallback
- ✅ Windows Credential Manager
- ✅ Retry logic on network errors
- ✅ Proper database schema alignment

---

## 🎯 Key Points for Backend

1. **Windows app sends `category: "other"`** for all activities
2. **Edge function should NOT expect AI fields** in the request (they're null)
3. **AI categorization happens AFTER insert** (async, doesn't block sync)
4. **Device info comes from deviceInfo object**, not from individual activities
5. **API key is in request body**, not Authorization header
6. **Timestamps are ISO 8601** with timezone: `2025-10-15T18:45:00Z`
7. **Activities sent instantly** on every app switch (no 60s delay)

---

## 📝 Example Logs

### Windows App Log (sensor.log)
```
2025-10-15T18:45:00Z    proc=chrome        title=GitHub    status=active    dur=90s
2025-10-15T18:46:30Z    proc=Code          title=Main.cs   status=active    dur=210s
```

### Edge Function Log
```
[sync-device-activity] Received 2 activities for device: abc-123
[sync-device-activity] Inserted 2 activities for user: xyz-789
[sync-device-activity] Updated device last_seen
[sync-device-activity] Triggered AI categorization
```

### Database State (Before AI)
```sql
SELECT app_name, category, ai_subcategory, ai_confidence 
FROM device_activities 
WHERE device_id = 'abc-123';
```
```
app_name              | category | ai_subcategory | ai_confidence
----------------------|----------|----------------|---------------
Google Chrome         | other    | NULL           | NULL
Visual Studio Code    | other    | NULL           | NULL
```

### Database State (After AI)
```sql
SELECT app_name, category, ai_subcategory, ai_confidence, productivity_score
FROM device_activities 
WHERE device_id = 'abc-123';
```
```
app_name              | category    | ai_subcategory | ai_confidence | productivity_score
----------------------|-------------|----------------|---------------|-------------------
Google Chrome         | research    | Web Browsing   | 85            | 60
Visual Studio Code    | productive  | Development    | 98            | 90
```

---

## 🚀 Testing the Integration

1. **Install app** with embedded config
2. **Use the app** (switch between Chrome, Code, etc.)
3. **Check Supabase** logs for incoming POST requests
4. **Query device_activities** to see inserted rows
5. **Wait for AI** categorization to complete
6. **View /sessions** page in dashboard to see categorized data

Expected behavior:
- ✅ Activities appear in database immediately (within seconds)
- ✅ `last_seen` timestamp updates on every sync
- ✅ AI fields populate within a few seconds after insert
- ✅ Dashboard shows real-time activity data
